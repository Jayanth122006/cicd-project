# This workflow is named "CI Pipeline"
name: CI Pipeline

# This workflow will be triggered on every push to the 'main' branch
on:
  push:
    branches: [ "main" ]

# A workflow run is made up of one or more jobs that can run in parallel
jobs:
  # The "build-backend" job
  build-backend:
    # The type of runner that the job will run on (a virtual machine)
    runs-on: ubuntu-latest

    steps:
      # Step 1: Check out the repository under $GITHUB_WORKSPACE, so the job can access it
      - name: Checkout Code
        uses: actions/checkout@v4

      # Step 2: Set up JDK 17, which is required by your Spring Boot application
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      # Step 3: Cache Maven packages to speed up future builds
      - name: Cache Maven packages
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      # Step 4: Grant execute permission to the Maven wrapper
      - name: Make Maven Wrapper Executable
        run: chmod +x ./auth-service/mvnw

      # Step 5: Build the Spring Boot application, SKIPPING the tests
      - name: Build Backend with Maven
        run: ./auth-service/mvnw -f ./auth-service/pom.xml clean install -DskipTests

  # The "build-frontend" job
  build-frontend:
    # This job also runs on the latest version of Ubuntu
    runs-on: ubuntu-latest

    steps:
      # Step 1: Check out the repository
      - name: Checkout Code
        uses: actions/checkout@v4

      # Step 2: Set up Node.js and enable dependency caching
      - name: Set up Node.js with cache
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: ./esports-frontend-master/package-lock.json

      # Step 3: Install all the frontend dependencies (will be fast if cache is hit)
      - name: Install Frontend Dependencies
        run: npm install --prefix ./esports-frontend-master

      # Step 4: Build the React application for production
      - name: Build Frontend
        run: npm run build --prefix ./esports-frontend-master

